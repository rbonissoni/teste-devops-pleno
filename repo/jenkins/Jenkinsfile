pipeline {agent any;stages{stage('Checkout'){steps{checkout scm}}stage('Build & Test'){steps{dir('app'){sh 'npm ci';sh 'npm test'}}}stage('Package'){steps{sh 'tar -czf package.tar.gz app';archiveArtifacts artifacts: 'package.tar.gz', fingerprint: true}}stage('Deploy'){steps{sh 'set -e; sudo mkdir -p /home/jenkins/deploy || true; cp package.tar.gz /home/jenkins/deploy/package.tar.gz || true; sudo bash deploy/deploy.sh'}}stage('Smoke'){steps{sh 'curl -fsSL http://127.0.0.1/health | tee smoke.json'}}}post{always{archiveArtifacts artifacts: 'smoke.json', allowEmptyArchive: true}}}